#!/bin/bash

prefix=@prefix@
pkgdatadir=@datarootdir@/@PACKAGE@
PYTHON=@PYTHON@

if [ $# -lt 1 ]; then
  echo "Usage: $0 disk_image" >&2
  exit 1
fi

get_abspath() {
  python3 -c 'import os,sys; print(os.path.abspath(os.path.expanduser(sys.argv[1])))' "$1"
}

imagefile=$1
imagefilebn=$(basename "$imagefile")
imagefileap=$(get_abspath "$imagefile")
outdir="${imagefilebn%.*}"

echo "fsnview: Debug: outdir: $outdir" >&2

echo "fsnview: Debug: Descending into output directory \"$outdir\"" >&2
mkdir -p "$outdir"
pushd "$outdir" >/dev/null

"$pkgdatadir/nversion.mk" \
  --keep-going \ 
  FIWALK_MAYBE_ALLOC_ONLY="-O" \
  PKGDATADIR="$pkgdatadir" \
  PREFIX="$prefix" \
  PYTHON="$PYTHON" \
  IMAGE="$imagefileap"

# Run report
echo "Exit statuses of all the DFXML-generating programs (should be 0's):"
grep '^' *.status.log | cat
echo ""
echo "Review these files for between-tool differences:"
ls diffs*.txt
echo ""
echo "Review these files for file system timelines according to each tool:"
ls mactimeline*.txt

popd >/dev/null
