#!/bin/bash

prefix=@prefix@
pkgdatadir=@datarootdir@/@PACKAGE@
PYTHON=@PYTHON@

usage="Usage: $0 [options] disk_image\n"
usage=$usage"\n"
usage=$usage"Options:\n"
usage=$usage"\t-d\n"
usage=$usage"\t  Enable debug printing\n"

debug=0

while [ $# -ge 1 ]; do
  case $1 in
    -d )
      debug=1
      ;;
    * )
      break
      ;;
  esac
  shift
done

if [ $# -lt 1 ]; then
  printf "$usage" >&2
  exit 1
fi

get_abspath() {
  python3 -c 'import os,sys; print(os.path.abspath(os.path.expanduser(sys.argv[1])))' "$1"
}

test $debug -eq 1 && set -x

imagefile=$1
imagefilebn=$(basename "$imagefile")
imagefileap=$(get_abspath "$imagefile")
outdir=$(get_abspath "${imagefilebn%.*}")

if [ $debug -eq 1 ]; then
  echo "fsnview: Debug: \$outdir: $outdir" >&2
  echo "fsnview: Debug: \$imagefileap: $imagefileap" >&2
  echo "fsnview: Debug: \$pkgdatadir: $pkgdatadir" >&2
fi

mkdir -p "$outdir"
test $debug -eq 1 && echo "fsnview: Debug: Descending into output directory \"$outdir\"" >&2
pushd "$outdir" >/dev/null

make \
  --directory="$outdir" \
  --makefile="$pkgdatadir/nversion.mk" \
  --keep-going \
  FIWALK_MAYBE_ALLOC_ONLY="-O" \
  PKGDATADIR="$pkgdatadir" \
  PREFIX="$prefix" \
  PYTHON="$PYTHON" \
  IMAGE="$imagefileap"

# Run report
echo "Exit statuses of all the DFXML-generating programs (should be 0's):"
grep '^' *.status.log | cat
echo ""
echo "Review these files for between-tool differences:"
ls diffs*.txt
echo ""
echo "Review these files for file system timelines according to each tool:"
ls mactimeline*.txt

popd >/dev/null
