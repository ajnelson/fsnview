#!/bin/bash

prefix="@prefix@"
pkgdatadir="@datarootdir@/@PACKAGE@"

disk_image="$1"
output_root="$2"

if [ ! -r "$disk_image" ]; then
  echo "$0: Error: Disk image file not readable." >&2
  exit 2
fi

do_xtaf=0

if [ true ]; then
  do_xtaf=1
fi

#Execute analysis scripts idempotently when possible
if [ $do_xtaf -eq 1 ]; then
  if [ ! -r "${output_root}/dfxml/analyze_with_uxtaf.sh.done.log" ]; then
    rm -rf "${output_root}/dfxml/analyze_with_uxtaf.sh*"
    "${pkgdatadir}/log_and_run_script.sh" "${pkgdatadir}/analyze_with_uxtaf.sh" "$disk_image" "${output_root}/dfxml/analyze_with_uxtaf.sh"
    if [ $? -eq 0 ]; then
      date >"${output_root}/dfxml/analyze_with_uxtaf.sh.done.log"
    fi
  fi

  if [ ! -r "${output_root}/dfxml/analyze_with_fiwalk.sh.done.log" ]; then
    rm -rf "${output_root}/dfxml/analyze_with_fiwalk.sh*"
    "${pkgdatadir}/log_and_run_script.sh" "${pkgdatadir}/analyze_with_fiwalk.sh" "$disk_image" "${output_root}/dfxml/analyze_with_fiwalk.sh"
    if [ $? -eq 0 ]; then
      date >"${output_root}/dfxml/analyze_with_fiwalk.sh.done.log"
    fi
  fi

  if [ ! -r "${output_root}/dfxml/analyze_with_py360.sh.done.log" ]; then
    rm -rf "${output_root}/dfxml/analyze_with_py360.sh*"
    "${pkgdatadir}/log_and_run_script.sh" "${pkgdatadir}/analyze_with_py360.sh" "$disk_image" "${output_root}/dfxml/analyze_with_py360.sh"
    if [ $? -eq 0 ]; then
      date >"${output_root}/dfxml/analyze_with_py360.sh.done.log"
    fi
  fi
fi
